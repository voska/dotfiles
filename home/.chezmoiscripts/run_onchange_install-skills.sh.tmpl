#!/bin/bash

set -eufo pipefail

# Install skills from lock file
# Hash: {{ include "dot_agents/dot_skill-lock.json" | sha256sum }}

# Ensure mise shims and homebrew are in PATH for non-interactive shells
[ -d "$HOME/.local/share/mise/shims" ] && export PATH="$HOME/.local/share/mise/shims:$PATH"
[ -x /opt/homebrew/bin/brew ] && eval "$(/opt/homebrew/bin/brew shellenv)"

if ! command -v pnpm &> /dev/null && ! command -v npx &> /dev/null; then
    echo "Skipping skills install: neither pnpm nor npx found"
    exit 0
fi

LOCK_FILE="$HOME/.agents/.skill-lock.json"

if [ ! -f "$LOCK_FILE" ]; then
    echo "Skipping skills install: no lock file found"
    exit 0
fi

if ! command -v jq &> /dev/null; then
    echo "Skipping skills install: jq not found"
    exit 0
fi

SKILLS_DIR="$HOME/.claude/skills"
missing=false
while IFS= read -r skill; do
    if [ ! -d "$SKILLS_DIR/$skill" ]; then
        missing=true
        break
    fi
done <<< "$(jq -r '.skills | keys[]' "$LOCK_FILE")"

if [ "$missing" = false ]; then
    echo "All skills already installed, skipping."
    exit 0
fi

echo "Installing skills from lock file..."

DLX="pnpm dlx"
if ! command -v pnpm &> /dev/null; then
    DLX="npx"
fi

while IFS= read -r line; do
    source="${line%% *}"
    skills="${line#* }"
    echo "Installing from $source..."
    $DLX skills add "$source" -g -y --skill $skills < /dev/null || echo "Warning: failed to install from $source"
done <<< "$(jq -r '
  .skills | to_entries | group_by(.value.source) | .[] |
  "\(.[0].value.source) \([.[].key] | join(" "))"
' "$LOCK_FILE")"

echo "Skills installation complete."
